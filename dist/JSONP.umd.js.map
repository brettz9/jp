{"version":3,"file":"JSONP.umd.js","sources":["../src/index.js"],"sourcesContent":["/* eslint-env node */\nconst ns = 'JSONP';\nconst prefix = '__JSONP__';\n\nconst isNode = typeof module !== 'undefined';\nlet request;\nif (isNode) {\n  // eslint-disable-next-line global-require\n  request = require('request');\n}\n\nfunction getQuery (callbackName, callbackVal, baseUrl = '', params = {}) {\n  let query = baseUrl.includes('?') ? '&' : '?';\n  Object.entries(params).forEach(([key, param]) => {\n    query += encodeURIComponent(key) + '=' + encodeURIComponent(param) + '&';\n  });\n  return baseUrl + query + (callbackName ? callbackName + '=' + callbackVal : '');\n}\n\nlet id = 0;\nasync function JSONP (url, options, params, callback) {\n  if (Array.isArray(url)) {\n    const results = [];\n    await url.reduce(async (p, u) => {\n      await p;\n      const result = await JSONP(u, options, params, callback);\n      results.push(result);\n    }, Promise.resolve());\n    return results;\n  }\n  if (arguments.length === 1 && url && typeof url === 'object') {\n    ({url, options, params, callback} = url);\n  }\n  if (typeof params === 'function') {\n    callback = params;\n    params = null;\n  } else if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  if (!options) {\n    options = {};\n  }\n  params = options.params || params;\n  const error = (err, reject) => reject(new Error('Script loading error.')); // eslint-disable-line handle-callback-err\n\n  const {\n    appendTo,\n    attrs = {},\n    callbackName = ns + '.' + prefix + id++,\n    callbackParam = 'callback',\n    callbackParent,\n    errorHandler = error,\n    removeCallBack = true,\n    removeScript = true,\n    timeout\n  } = options;\n\n  const where = isNode\n    ? null\n    : appendTo\n      ? document.querySelector(appendTo)\n      : (document.body || document.head);\n  if (!isNode && !where) {\n    throw new Error('No DOM element onto which one may append the script');\n  }\n\n  let script;\n  if (!isNode) {\n    script = document.createElement('script');\n    script.async = true;\n    Object.entries(attrs).forEach(([attr, attrValue]) => {\n      script.setAttribute(attr, attrValue);\n    });\n  }\n\n  return new Promise((resolve, reject) => {\n    let timer;\n    if (timeout) {\n      timer = setTimeout(() => {\n        reject(new Error('JSONP request timed out.'));\n      }, timeout);\n    }\n    if (!isNode) {\n      script.addEventListener('error', (err) => {\n        errorHandler(err, reject);\n      });\n    }\n\n    if (callbackName) { // If falsy value given, JSONP script is expected to call an existing function\n      const [parent, methodName] = JSONP.findParentAndChildOfMethod(callbackName, callbackParent);\n\n      const JSONPResponse = (resp) => {\n        if (removeCallBack) {\n          try {\n            delete parent[methodName];\n          } catch (e) {\n            parent[methodName] = null;\n          }\n        }\n        // eslint-disable-next-line unicorn/prefer-node-remove\n        if (where && removeScript) where.removeChild(script);\n\n        clearTimeout(timer);\n\n        if (callback) {\n          callback(resp, resolve, reject);\n          return;\n        }\n        resolve(resp);\n      };\n      parent[methodName] = JSONPResponse;\n    }\n\n    JSONP.srcs.push(callbackName);\n    url = getQuery(callbackParam, callbackName, url, params);\n    if (isNode) {\n      const options = {\n        url,\n        headers: {\n          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36'\n        }\n      };\n      request(options, function (err, res, body) {\n        if (err) throw err;\n        else if (res.statusCode === 200) {\n          const cb = new Function(body); // eslint-disable-line no-new-func\n          // eslint-disable-next-line callback-return\n          cb();\n        }\n      });\n    } else {\n      // eslint-disable-next-line unicorn/prefer-node-append\n      where.appendChild(script).src = url;\n    }\n  });\n}\n\nJSONP.srcs = [];\n\nJSONP.findParentAndChildOfMethod = function (callbackName, baseObject = typeof window === 'undefined' ? global : window) {\n  const props = callbackName.split('.');\n  const methodName = props.pop();\n  const parent = props.reduce((par, prop) => par[prop], baseObject);\n  return [parent, methodName];\n};\n\nJSONP.executeCallback = function (obj, {callbackParam, baseObject} = {callbackParam: 'callback'}) {\n  const callbackName = JSONP.srcs.shift();\n  if (callbackName.trim() === 'JSONP.executeCallback') {\n    throw new TypeError('JSONP.executeCallback cannot be supplied itself');\n  }\n  const [parent, child] = JSONP.findParentAndChildOfMethod(callbackName, baseObject);\n  return parent[child](obj);\n};\n\nexport default JSONP;\n"],"names":["value","then","direct","Promise","resolve","JSONP","url","options","params","callback","arguments","Array","isArray","results","reduce","p","u","result","push","length","error","err","reject","Error","appendTo","attrs","callbackName","ns","prefix","id","callbackParam","callbackParent","errorHandler","removeCallBack","removeScript","timeout","where","isNode","document","querySelector","body","head","script","createElement","async","Object","entries","forEach","attr","attrValue","setAttribute","timer","setTimeout","addEventListener","parent","methodName","findParentAndChildOfMethod","JSONPResponse","resp","e","removeChild","clearTimeout","srcs","getQuery","headers","request","res","statusCode","cb","Function","appendChild","src","_invoke","_async","f","args","i","apply","module","require","callbackVal","baseUrl","query","includes","key","param","encodeURIComponent","baseObject","window","global","props","split","pop","par","prop","executeCallback","obj","shift","trim","TypeError","child"],"mappings":"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"}