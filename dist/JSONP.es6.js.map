{"version":3,"file":"JSONP.es6.js","sources":["../src/index.js"],"sourcesContent":["/* eslint-env node */\nconst ns = 'JSONP';\nconst prefix = '__JSONP__';\n\nconst isNode = typeof module !== 'undefined';\nlet request;\nif (isNode) {\n  // eslint-disable-next-line global-require\n  request = require('request');\n}\n\nfunction getQuery (callbackName, callbackVal, baseUrl = '', params = {}) {\n  let query = baseUrl.includes('?') ? '&' : '?';\n  Object.entries(params).forEach(([key, param]) => {\n    query += encodeURIComponent(key) + '=' + encodeURIComponent(param) + '&';\n  });\n  return baseUrl + query + (callbackName ? callbackName + '=' + callbackVal : '');\n}\n\nlet id = 0;\nasync function JSONP (url, options, params, callback) {\n  if (Array.isArray(url)) {\n    const results = [];\n    await url.reduce(async (p, u) => {\n      await p;\n      const result = await JSONP(u, options, params, callback);\n      results.push(result);\n    }, Promise.resolve());\n    return results;\n  }\n  if (arguments.length === 1 && url && typeof url === 'object') {\n    ({url, options, params, callback} = url);\n  }\n  if (typeof params === 'function') {\n    callback = params;\n    params = null;\n  } else if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  if (!options) {\n    options = {};\n  }\n  params = options.params || params;\n  const error = (err, reject) => reject(new Error('Script loading error.')); // eslint-disable-line handle-callback-err\n\n  const {\n    appendTo,\n    attrs = {},\n    callbackName = ns + '.' + prefix + id++,\n    callbackParam = 'callback',\n    callbackParent,\n    errorHandler = error,\n    removeCallBack = true,\n    removeScript = true,\n    timeout\n  } = options;\n\n  const where = isNode\n    ? null\n    : appendTo\n      ? document.querySelector(appendTo)\n      : (document.body || document.head);\n  if (!isNode && !where) {\n    throw new Error('No DOM element onto which one may append the script');\n  }\n\n  let script;\n  if (!isNode) {\n    script = document.createElement('script');\n    script.async = true;\n    Object.entries(attrs).forEach(([attr, attrValue]) => {\n      script.setAttribute(attr, attrValue);\n    });\n  }\n\n  return new Promise((resolve, reject) => {\n    let timer;\n    if (timeout) {\n      timer = setTimeout(() => {\n        reject(new Error('JSONP request timed out.'));\n      }, timeout);\n    }\n    if (!isNode) {\n      script.addEventListener('error', (err) => {\n        errorHandler(err, reject);\n      });\n    }\n\n    if (callbackName) { // If falsy value given, JSONP script is expected to call an existing function\n      const [parent, methodName] = JSONP.findParentAndChildOfMethod(callbackName, callbackParent);\n\n      const JSONPResponse = (resp) => {\n        if (removeCallBack) {\n          try {\n            delete parent[methodName];\n          } catch (e) {\n            parent[methodName] = null;\n          }\n        }\n        if (where && removeScript) where.removeChild(script);\n\n        clearTimeout(timer);\n\n        if (callback) {\n          callback(resp, resolve, reject);\n          return;\n        }\n        resolve(resp);\n      };\n      parent[methodName] = JSONPResponse;\n    }\n\n    JSONP.srcs.push(callbackName);\n    url = getQuery(callbackParam, callbackName, url, params);\n    if (isNode) {\n      const options = {\n        url,\n        headers: {\n          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36'\n        }\n      };\n      request(options, function (err, res, body) {\n        if (err) throw err;\n        else if (res.statusCode === 200) {\n          const cb = new Function(body); // eslint-disable-line no-new-func\n          // eslint-disable-next-line callback-return\n          cb();\n        }\n      });\n    } else {\n      // eslint-disable-next-line unicorn/prefer-node-append\n      where.appendChild(script).src = url;\n    }\n  });\n}\n\nJSONP.srcs = [];\n\nJSONP.findParentAndChildOfMethod = function (callbackName, baseObject = typeof window === 'undefined' ? global : window) {\n  const props = callbackName.split('.');\n  const methodName = props.pop();\n  const parent = props.reduce((par, prop) => par[prop], baseObject);\n  return [parent, methodName];\n};\n\nJSONP.executeCallback = function (obj, {callbackParam, baseObject} = {callbackParam: 'callback'}) {\n  const callbackName = JSONP.srcs.shift();\n  if (callbackName.trim() === 'JSONP.executeCallback') {\n    throw new TypeError('JSONP.executeCallback cannot be supplied itself');\n  }\n  const [parent, child] = JSONP.findParentAndChildOfMethod(callbackName, baseObject);\n  return parent[child](obj);\n};\n\nexport default JSONP;\n"],"names":["value","then","direct","Promise","resolve","JSONP","url","options","params","callback","arguments","Array","isArray","results","reduce","p","u","result","push","length","error","err","reject","Error","appendTo","attrs","callbackName","ns","prefix","id","callbackParam","callbackParent","errorHandler","removeCallBack","removeScript","timeout","where","isNode","document","querySelector","body","head","script","createElement","async","Object","entries","forEach","attr","attrValue","setAttribute","timer","setTimeout","addEventListener","parent","methodName","findParentAndChildOfMethod","JSONPResponse","resp","e","removeChild","clearTimeout","srcs","getQuery","headers","request","res","statusCode","cb","Function","appendChild","src","_invoke","_async","f","args","i","apply","module","require","callbackVal","baseUrl","query","includes","key","param","encodeURIComponent","baseObject","window","global","props","split","pop","par","prop","executeCallback","obj","shift","trim","TypeError","child"],"mappings":"AAoFO,gBAAgBA,KAAhB,EAAuBC,IAAvB,EAA6BC,MAA7B,EAAqC;MACvCA,MAAJ,EAAY;WACJD,IAAI,GAAGA,IAAI,CAACD,KAAD,CAAP,GAAiBA,KAA5B;;;MAEG,CAACA,KAAD,IAAU,CAACA,KAAK,CAACC,IAArB,EAA2B;IAC1BD,KAAK,GAAGG,OAAO,CAACC,OAAR,CAAgBJ,KAAhB,CAAR;;;SAEMC,IAAI,GAAGD,KAAK,CAACC,IAAN,CAAWA,IAAX,CAAH,GAAsBD,KAAjC;;;MAvEcK,yBAAOC,KAAKC,SAASC,QAAQC,UAAU;;qBAUhDC,SAVgD;;QAChDC,KAAK,CAACC,OAAN,CAAcN,GAAd,CADgD;YAE5CO,OAAO,GAAG,EAAhB;oBACMP,GAAG,CAACQ,MAAJ,WAAkBC,CAAlB,EAAqBC,CAArB,EAA2B;sBACzBD,CADyB;wBAEVV,KAAK,CAACW,CAAD,EAAIT,OAAJ,EAAaC,MAAb,EAAqBC,QAArB,CAFK,YAEzBQ,MAFyB;YAG/BJ,OAAO,CAACK,IAAR,CAAaD,MAAb;;;OAHI,EAIHd,OAAO,CAACC,OAAR,EAJG,CAH4C;;eAQ3CS,OAR2C;;;;;;QAUhD,WAAUM,MAAV,KAAqB,CAArB,IAA0Bb,GAA1B,IAAiC,OAAOA,GAAP,KAAe,QAApD,EAA8D;OAC3D;QAACA,GAAD;QAAMC,OAAN;QAAeC,MAAf;QAAuBC;UAAYH,GAApC;;;QAEE,OAAOE,MAAP,KAAkB,UAAtB,EAAkC;MAChCC,QAAQ,GAAGD,MAAX;MACAA,MAAM,GAAG,IAAT;KAFF,MAGO,IAAI,OAAOD,OAAP,KAAmB,UAAvB,EAAmC;MACxCE,QAAQ,GAAGF,OAAX;MACAA,OAAO,GAAG,EAAV;;;QAEE,CAACA,OAAL,EAAc;MACZA,OAAO,GAAG,EAAV;;;IAEFC,MAAM,GAAGD,OAAO,CAACC,MAAR,IAAkBA,MAA3B;;UACMY,KAAK,GAAG,CAACC,GAAD,EAAMC,MAAN,KAAiBA,MAAM,CAAC,IAAIC,KAAJ,CAAU,uBAAV,CAAD,CAArC,CAxBoD;;;UA0B9C;MACJC,QADI;MAEJC,KAAK,GAAG,EAFJ;MAGJC,YAAY,GAAGC,EAAE,GAAG,GAAL,GAAWC,MAAX,GAAoBC,EAAE,EAHjC;MAIJC,aAAa,GAAG,UAJZ;MAKJC,cALI;MAMJC,YAAY,GAAGZ,KANX;MAOJa,cAAc,GAAG,IAPb;MAQJC,YAAY,GAAG,IARX;MASJC;QACE5B,OAVJ;UAYM6B,KAAK,GAAGC,MAAM,GAChB,IADgB,GAEhBb,QAAQ,GACNc,QAAQ,CAACC,aAAT,CAAuBf,QAAvB,CADM,GAELc,QAAQ,CAACE,IAAT,IAAiBF,QAAQ,CAACG,IAJjC;;QAKI,CAACJ,MAAD,IAAW,CAACD,KAAhB,EAAuB;YACf,IAAIb,KAAJ,CAAU,qDAAV,CAAN;;;QAGEmB,MAAJ;;QACI,CAACL,MAAL,EAAa;MACXK,MAAM,GAAGJ,QAAQ,CAACK,aAAT,CAAuB,QAAvB,CAAT;MACAD,MAAM,CAACE,KAAP,GAAe,IAAf;MACAC,MAAM,CAACC,OAAP,CAAerB,KAAf,EAAsBsB,OAAtB,CAA8B,CAAC,CAACC,IAAD,EAAOC,SAAP,CAAD,KAAuB;QACnDP,MAAM,CAACQ,YAAP,CAAoBF,IAApB,EAA0BC,SAA1B;OADF;;;WAKK,IAAI9C,OAAJ,CAAY,CAACC,OAAD,EAAUkB,MAAV,KAAqB;UAClC6B,KAAJ;;UACIhB,OAAJ,EAAa;QACXgB,KAAK,GAAGC,UAAU,CAAC,MAAM;UACvB9B,MAAM,CAAC,IAAIC,KAAJ,CAAU,0BAAV,CAAD,CAAN;SADgB,EAEfY,OAFe,CAAlB;;;UAIE,CAACE,MAAL,EAAa;QACXK,MAAM,CAACW,gBAAP,CAAwB,OAAxB,EAAkChC,GAAD,IAAS;UACxCW,YAAY,CAACX,GAAD,EAAMC,MAAN,CAAZ;SADF;;;UAKEI,YAAJ,EAAkB;;cACV,CAAC4B,MAAD,EAASC,UAAT,IAAuBlD,KAAK,CAACmD,0BAAN,CAAiC9B,YAAjC,EAA+CK,cAA/C,CAA7B;;cAEM0B,aAAa,GAAIC,IAAD,IAAU;cAC1BzB,cAAJ,EAAoB;gBACd;qBACKqB,MAAM,CAACC,UAAD,CAAb;aADF,CAEE,OAAOI,CAAP,EAAU;cACVL,MAAM,CAACC,UAAD,CAAN,GAAqB,IAArB;;;;cAGAnB,KAAK,IAAIF,YAAb,EAA2BE,KAAK,CAACwB,WAAN,CAAkBlB,MAAlB;UAE3BmB,YAAY,CAACV,KAAD,CAAZ;;cAEI1C,QAAJ,EAAc;YACZA,QAAQ,CAACiD,IAAD,EAAOtD,OAAP,EAAgBkB,MAAhB,CAAR;;;;UAGFlB,OAAO,CAACsD,IAAD,CAAP;SAhBF;;QAkBAJ,MAAM,CAACC,UAAD,CAAN,GAAqBE,aAArB;;;MAGFpD,KAAK,CAACyD,IAAN,CAAW5C,IAAX,CAAgBQ,YAAhB;MACApB,GAAG,GAAGyD,QAAQ,CAACjC,aAAD,EAAgBJ,YAAhB,EAA8BpB,GAA9B,EAAmCE,MAAnC,CAAd;;UACI6B,MAAJ,EAAY;cACJ9B,OAAO,GAAG;UACdD,GADc;UAEd0D,OAAO,EAAE;0BACO;;SAHlB;QAMAC,OAAO,CAAC1D,OAAD,EAAU,UAAUc,GAAV,EAAe6C,GAAf,EAAoB1B,IAApB,EAA0B;cACrCnB,GAAJ,EAAS,MAAMA,GAAN,CAAT,KACK,IAAI6C,GAAG,CAACC,UAAJ,KAAmB,GAAvB,EAA4B;kBACzBC,EAAE,GAAG,IAAIC,QAAJ,CAAa7B,IAAb,CAAX,CAD+B;;;YAG/B4B,EAAE;;SALC,CAAP;OAPF,MAeO;;QAELhC,KAAK,CAACkC,WAAN,CAAkB5B,MAAlB,EAA0B6B,GAA1B,GAAgCjE,GAAhC;;KAxDG,CAAP;;;;AAqdK,SAASkE,OAAT,CAAiBhC,IAAjB,EAAuBvC,IAAvB,EAA6B;MAC/BgB,MAAM,GAAGuB,IAAI,EAAjB;;MACIvB,MAAM,IAAIA,MAAM,CAAChB,IAArB,EAA2B;WACnBgB,MAAM,CAAChB,IAAP,CAAYA,IAAZ,CAAP;;;SAEMA,IAAI,CAACgB,MAAD,CAAX;;;;AAriBD,MAAMU,EAAE,GAAG,OAAX;;AAqEO,SAAS8C,MAAT,CAAgBC,CAAhB,EAAmB;SAClB,YAAW;SACZ,IAAIC,IAAI,GAAG,EAAX,EAAeC,CAAC,GAAG,CAAxB,EAA2BA,CAAC,GAAGlE,SAAS,CAACS,MAAzC,EAAiDyD,CAAC,EAAlD,EAAsD;MACrDD,IAAI,CAACC,CAAD,CAAJ,GAAUlE,SAAS,CAACkE,CAAD,CAAnB;;;QAEG;aACIzE,OAAO,CAACC,OAAR,CAAgBsE,CAAC,CAACG,KAAF,CAAQ,IAAR,EAAcF,IAAd,CAAhB,CAAP;KADD,CAEE,OAAMhB,CAAN,EAAS;aACHxD,OAAO,CAACmB,MAAR,CAAeqC,CAAf,CAAP;;GAPF;;;AArED,MAAM/B,MAAM,GAAG,WAAf;AAEA,MAAMS,MAAM,GAAG,OAAOyC,MAAP,KAAkB,WAAjC;AACA,IAAIb,OAAJ;;AACA,IAAI5B,MAAJ,EAAY;;EAEV4B,OAAO,GAAGc,OAAO,CAAC,SAAD,CAAjB;;;AAGF,SAAShB,QAAT,CAAmBrC,YAAnB,EAAiCsD,WAAjC,EAA8CC,OAAO,GAAG,EAAxD,EAA4DzE,MAAM,GAAG,EAArE,EAAyE;MACnE0E,KAAK,GAAGD,OAAO,CAACE,QAAR,CAAiB,GAAjB,IAAwB,GAAxB,GAA8B,GAA1C;EACAtC,MAAM,CAACC,OAAP,CAAetC,MAAf,EAAuBuC,OAAvB,CAA+B,CAAC,CAACqC,GAAD,EAAMC,KAAN,CAAD,KAAkB;IAC/CH,KAAK,IAAII,kBAAkB,CAACF,GAAD,CAAlB,GAA0B,GAA1B,GAAgCE,kBAAkB,CAACD,KAAD,CAAlD,GAA4D,GAArE;GADF;SAGOJ,OAAO,GAAGC,KAAV,IAAmBxD,YAAY,GAAGA,YAAY,GAAG,GAAf,GAAqBsD,WAAxB,GAAsC,EAArE,CAAP;;;AAGF,IAAInD,EAAE,GAAG,CAAT;AAsHAxB,KAAK,CAACyD,IAAN,GAAa,EAAb;;AAEAzD,KAAK,CAACmD,0BAAN,GAAmC,UAAU9B,YAAV,EAAwB6D,UAAU,GAAG,OAAOC,MAAP,KAAkB,WAAlB,GAAgCC,MAAhC,GAAyCD,MAA9E,EAAsF;QACjHE,KAAK,GAAGhE,YAAY,CAACiE,KAAb,CAAmB,GAAnB,CAAd;QACMpC,UAAU,GAAGmC,KAAK,CAACE,GAAN,EAAnB;QACMtC,MAAM,GAAGoC,KAAK,CAAC5E,MAAN,CAAa,CAAC+E,GAAD,EAAMC,IAAN,KAAeD,GAAG,CAACC,IAAD,CAA/B,EAAuCP,UAAvC,CAAf;SACO,CAACjC,MAAD,EAASC,UAAT,CAAP;CAJF;;AAOAlD,KAAK,CAAC0F,eAAN,GAAwB,UAAUC,GAAV,EAAe;EAAClE,aAAD;EAAgByD;IAAc;EAACzD,aAAa,EAAE;CAA7D,EAA0E;QAC1FJ,YAAY,GAAGrB,KAAK,CAACyD,IAAN,CAAWmC,KAAX,EAArB;;MACIvE,YAAY,CAACwE,IAAb,OAAwB,uBAA5B,EAAqD;UAC7C,IAAIC,SAAJ,CAAc,iDAAd,CAAN;;;QAEI,CAAC7C,MAAD,EAAS8C,KAAT,IAAkB/F,KAAK,CAACmD,0BAAN,CAAiC9B,YAAjC,EAA+C6D,UAA/C,CAAxB;SACOjC,MAAM,CAAC8C,KAAD,CAAN,CAAcJ,GAAd,CAAP;CANF;;;;"}