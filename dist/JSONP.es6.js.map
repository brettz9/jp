{"version":3,"file":"JSONP.es6.js","sources":["../src/index.js"],"sourcesContent":["/* eslint-env node */\nconst ns = 'JSONP';\nconst prefix = '__JSONP__';\n\nconst isNode = typeof module !== 'undefined';\nlet request;\nif (isNode) {\n  // eslint-disable-next-line global-require\n  request = require('request');\n}\n\nfunction getQuery (callbackName, callbackVal, baseUrl = '', params = {}) {\n  let query = baseUrl.includes('?') ? '&' : '?';\n  Object.entries(params).forEach(([key, param]) => {\n    query += encodeURIComponent(key) + '=' + encodeURIComponent(param) + '&';\n  });\n  return baseUrl + query + (callbackName ? callbackName + '=' + callbackVal : '');\n}\n\nlet id = 0;\nasync function JSONP (url, options, params, callback) {\n  if (Array.isArray(url)) {\n    const results = [];\n    await url.reduce(async (p, u) => {\n      await p;\n      const result = await JSONP(u, options, params, callback);\n      results.push(result);\n    }, Promise.resolve());\n    return results;\n  }\n  if (arguments.length === 1 && url && typeof url === 'object') {\n    ({url, options, params, callback} = url);\n  }\n  if (typeof params === 'function') {\n    callback = params;\n    params = null;\n  } else if (typeof options === 'function') {\n    callback = options;\n    options = {};\n  }\n  if (!options) {\n    options = {};\n  }\n  params = options.params || params;\n  const error = (err, reject) => reject(new Error('Script loading error.')); // eslint-disable-line handle-callback-err\n\n  const {\n    appendTo,\n    attrs = {},\n    callbackName = ns + '.' + prefix + id++,\n    callbackParam = 'callback',\n    callbackParent,\n    errorHandler = error,\n    removeCallBack = true,\n    removeScript = true,\n    timeout\n  } = options;\n\n  const where = isNode\n    ? null\n    : appendTo\n      ? document.querySelector(appendTo)\n      : (document.body || document.head);\n  if (!isNode && !where) {\n    throw new Error('No DOM element onto which one may append the script');\n  }\n\n  let script;\n  if (!isNode) {\n    script = document.createElement('script');\n    script.async = true;\n    Object.entries(attrs).forEach(([attr, attrValue]) => {\n      script.setAttribute(attr, attrValue);\n    });\n  }\n\n  return new Promise((resolve, reject) => {\n    let timer;\n    if (timeout) {\n      timer = setTimeout(() => {\n        reject(new Error('JSONP request timed out.'));\n      }, timeout);\n    }\n    if (!isNode) {\n      script.addEventListener('error', (err) => {\n        errorHandler(err, reject);\n      });\n    }\n\n    if (callbackName) { // If falsy value given, JSONP script is expected to call an existing function\n      const [parent, methodName] = JSONP.findParentAndChildOfMethod(callbackName, callbackParent);\n\n      const JSONPResponse = (resp) => {\n        if (removeCallBack) {\n          try {\n            delete parent[methodName];\n          } catch (e) {\n            parent[methodName] = null;\n          }\n        }\n        if (where && removeScript) where.removeChild(script);\n\n        clearTimeout(timer);\n\n        if (callback) {\n          callback(resp, resolve, reject);\n          return;\n        }\n        resolve(resp);\n      };\n      parent[methodName] = JSONPResponse;\n    }\n\n    JSONP.srcs.push(callbackName);\n    url = getQuery(callbackParam, callbackName, url, params);\n    if (isNode) {\n      const options = {\n        url,\n        headers: {\n          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/45.0.2454.101 Safari/537.36'\n        }\n      };\n      request(options, function (err, res, body) {\n        if (err) throw err;\n        else if (res.statusCode === 200) {\n          const cb = new Function(body); // eslint-disable-line no-new-func\n          // eslint-disable-next-line callback-return\n          cb();\n        }\n      });\n    } else {\n      // eslint-disable-next-line unicorn/prefer-node-append\n      where.appendChild(script).src = url;\n    }\n  });\n}\n\nJSONP.srcs = [];\n\nJSONP.findParentAndChildOfMethod = function (callbackName, baseObject = typeof window === 'undefined' ? global : window) {\n  const props = callbackName.split('.');\n  const methodName = props.pop();\n  const parent = props.reduce((par, prop) => par[prop], baseObject);\n  return [parent, methodName];\n};\n\nJSONP.executeCallback = function (obj, {callbackParam, baseObject} = {callbackParam: 'callback'}) {\n  const callbackName = JSONP.srcs.shift();\n  if (callbackName.trim() === 'JSONP.executeCallback') {\n    throw new TypeError('JSONP.executeCallback cannot be supplied itself');\n  }\n  const [parent, child] = JSONP.findParentAndChildOfMethod(callbackName, baseObject);\n  return parent[child](obj);\n};\n\nexport default JSONP;\n"],"names":["value","then","direct","Promise","resolve","JSONP","url","options","params","callback","arguments","Array","isArray","results","reduce","p","u","result","push","length","error","err","reject","Error","appendTo","attrs","callbackName","ns","prefix","id","callbackParam","callbackParent","errorHandler","removeCallBack","removeScript","timeout","where","isNode","document","querySelector","body","head","script","createElement","async","Object","entries","forEach","attr","attrValue","setAttribute","timer","setTimeout","addEventListener","parent","methodName","findParentAndChildOfMethod","JSONPResponse","resp","e","removeChild","clearTimeout","srcs","getQuery","headers","request","res","statusCode","cb","Function","appendChild","src","_invoke","_async","f","args","i","apply","module","require","callbackVal","baseUrl","query","includes","key","param","encodeURIComponent","baseObject","window","global","props","split","pop","par","prop","executeCallback","obj","shift","trim","TypeError","child"],"mappings":"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"}